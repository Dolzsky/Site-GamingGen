<!DOCTYPE html>

<html>
<head>
  <title>users.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>users.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Récupération des schémas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> userSchema = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../Model/userSchema'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Récupération des modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> express       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> router        = express.Router();
<span class="hljs-keyword">var</span> crypto        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
<span class="hljs-keyword">var</span> passport      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);
<span class="hljs-keyword">var</span> nodemailer    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nodemailer'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Confs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> cryptoSecret   = <span class="hljs-string">'GamingGenCryptoCat'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">from</span>           = <span class="hljs-string">'"Gaming Gen" &lt;noreply@gaming-gen.fr&gt;'</span>;
<span class="hljs-keyword">const</span> subject        = <span class="hljs-string">'Inscription à la Gaming Gen'</span>;
<span class="hljs-keyword">let</span> text             = <span class="hljs-string">''</span>;
<span class="hljs-keyword">let</span> registrationHtml = <span class="hljs-string">`
[logo GG]
&lt;br/&gt;
Hello,
&lt;br/&gt;&lt;br/&gt;
Tu reçois cet e-mail car tu as créé un compte sur le site www.gaming-gen.fr.
&lt;br/&gt;&lt;br/&gt;
Afin de confirmer ton adresse e-mail et de valider ton enregistrement, clique sur le bouton ci-dessous :
&lt;br/&gt;
[bouton]
&lt;br/&gt;
S'il ne fonctionne pas, copie ce lien et colle le dans la barre d'adresse de ton navigateur : [lien]
&lt;br/&gt;&lt;br/&gt;
Une fois ton compte validé, tu pourras personnaliser ton profil, t'inscrire aux tournois, enregistrer ton équipe, réserver ta place, venir à la GG6, gagner tous tes matchs, devenir une star internationale et bien plus encore... 
&lt;br/&gt;&lt;br/&gt;
A très vite !
&lt;br/&gt;&lt;br/&gt;
Gaming Gen,
&lt;br/&gt;
Le Jeu est dans nos gènes.
&lt;br/&gt;&lt;br/&gt;
--
Ce message a été envoyé automatiquement. Merci de ne pas répondre.
&lt;br/&gt;
[Footer] www.gaming-gen.fr [picto Facebook] [picto Twitter] [picto Instagram]`</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>create reusable transporter object using SMTP transport </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> transporter = nodemailer.createTransport({
    <span class="hljs-attr">service</span>: <span class="hljs-string">'Gmail'</span>,
    <span class="hljs-attr">auth</span>: {
        <span class="hljs-attr">user</span>: process.env.NODEMAILER_USER,
        <span class="hljs-attr">pass</span>: process.env.NODEMAILER_PASS
    }
});


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SendMail</span>(<span class="hljs-params">req, res, mails, html, hash</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Sending Mail...'</span>.info);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Gestion mail Inscription</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (hash) {
    <span class="hljs-keyword">const</span> validationLink = <span class="hljs-string">`<span class="hljs-subst">${req.protocol}</span>://<span class="hljs-subst">${req.headers.host}</span>/#/users/validate/<span class="hljs-subst">${hash}</span>`</span>;
    html = registrationHtml.replace(<span class="hljs-string">'[lien]'</span>, validationLink);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>setup e-mail data with unicode symbols </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> mailOptions = {
      <span class="hljs-attr">from</span>: <span class="hljs-keyword">from</span>, <span class="hljs-comment">// sender address </span>
      to: mails, <span class="hljs-comment">// list of receivers </span>
      subject: subject, <span class="hljs-comment">// Subject line </span>
      text: text, <span class="hljs-comment">// plaintext body </span>
      html: html, <span class="hljs-comment">// html body</span>
      attachments: []
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Pour attacher des pièces
for(let IMG of tabIMG) {
  attach = {};
  attach.filename = IMG;
  attach.path = IMG;
  mailOptions.attachments.push(attach);
}</p>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>send mail with defined transport object </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  transporter.sendMail(mailOptions, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, info</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'info: '</span>, info);
      <span class="hljs-keyword">if</span>(error) {
        <span class="hljs-built_in">console</span>.log(error);
        res.sendStatus(<span class="hljs-number">500</span>);
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Message sent: <span class="hljs-subst">${info}</span>`</span>);
        res.sendStatus(<span class="hljs-number">200</span>);
      }
  });
}




router.post(<span class="hljs-string">'/login'</span>, login);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>passport.authenticate(‘local’), (req, res) =&gt; {
  if (req.user) {
    console.log(‘User: ‘ + req.user.pseudo + ‘ Connecté’);
    res.sendStatus(200);
  }
  else {
    res.sendStatus(401);
  }
});</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>router.post(‘/login’, (req, res) =&gt; {
  console.log(‘Bad Auth’);
  res.sendStatus(401);
});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
router.post(<span class="hljs-string">'/logout'</span>, (req, res) =&gt; {
  <span class="hljs-built_in">console</span>.log(req.user);
  req.logout();
  res.sendStatus(<span class="hljs-number">200</span>);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>En cour de tests</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>router.get(<span class="hljs-string">'/'</span>, (req, res) =&gt; {
    userSchema.findOne({<span class="hljs-attr">pseudo</span>: <span class="hljs-string">'DarkTerra'</span>}).populate(<span class="hljs-string">'name'</span>).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, docs</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.log(err);
      }
      <span class="hljs-keyword">else</span> {
        res.json(docs);
      }
    });
});</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>router.post(‘/update’, function(req, res) {
  userSchema.findOneAndUpdate({
    req.params.oldParametterToFind: req.params.oldValueToFind
  },
  {
    req.params.newParametterToFind: req.params.newValueToFind
  },
  function(err, user) {
    console.log((user));
  });
});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
router.post(<span class="hljs-string">'/insert'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-keyword">let</span> hash = crypto.createHmac(<span class="hljs-string">'sha256'</span>, cryptoSecret)
    .update(req.body.pseudo + req.body.email + <span class="hljs-built_in">Date</span>.now())
    .digest(<span class="hljs-string">'hex'</span>);
  
  <span class="hljs-keyword">let</span> newUser = <span class="hljs-keyword">new</span> userSchema({
    <span class="hljs-attr">pseudo</span>    : req.body.pseudo,
    <span class="hljs-attr">password</span>  : req.body.password,
    <span class="hljs-attr">email</span>     : req.body.email,
    <span class="hljs-attr">general</span>   : {
      <span class="hljs-attr">first_name</span>    : req.body.general.first_name,
      <span class="hljs-attr">last_name</span>     : req.body.general.last_name,
      <span class="hljs-attr">birthday</span>      : req.body.general.birthday,
      <span class="hljs-attr">zip</span>           : req.body.general.zip
    },
    <span class="hljs-attr">access</span>    : {
      <span class="hljs-attr">validationKey</span> : hash
    }
  });
  
  newUser.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-built_in">console</span>.log(err);
      res.sendStatus(<span class="hljs-number">500</span>);
    }
    <span class="hljs-keyword">else</span>
    {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Envoit du mail</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      SendMail(req, res, [newUser.email], text, hash);
    }
  });
});

<span class="hljs-comment">/**
 * Récupération de la liste des utilisateurs non-bannis
 */</span>
router.get(<span class="hljs-string">'/listNoBan'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  userSchema.find({<span class="hljs-string">'access.ban'</span> : <span class="hljs-literal">false</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, rows</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-built_in">console</span>.log(err);
      res.sendStatus(<span class="hljs-number">500</span>);
    } <span class="hljs-keyword">else</span> {
      res.json(rows);
    }
  });
});

<span class="hljs-comment">/**
 * Récupération de la liste des utilisateurs bannis
 */</span>
router.get(<span class="hljs-string">'/listBan'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  userSchema.find({<span class="hljs-string">'access.ban'</span> : <span class="hljs-literal">true</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, rows</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-built_in">console</span>.log(err);
      res.sendStatus(<span class="hljs-number">500</span>);
    } <span class="hljs-keyword">else</span> {
      res.json(rows);
    }
  });
});

<span class="hljs-comment">/**
 * Bannissement d'un utilisateur
 */</span>
router.post(<span class="hljs-string">'/ban'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
   userSchema.findOneAndUpdate({<span class="hljs-string">'pseudo'</span> : req.body.user}, {<span class="hljs-string">'access.ban'</span> : <span class="hljs-literal">true</span>},<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, rows</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-built_in">console</span>.log(err);
      res.sendStatus(<span class="hljs-number">500</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">let</span> serverEvent  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./ServerEvent'</span>);
      serverEvent.emit(<span class="hljs-string">'BanUser'</span>, req.body.user);
      res.sendStatus(<span class="hljs-number">200</span>);
    }
  });
});

<span class="hljs-comment">/**
 * Dé-bannissement d'un utilisateur
 */</span>
router.post(<span class="hljs-string">'/unban'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
  userSchema.findOneAndUpdate({<span class="hljs-string">'pseudo'</span> : req.body.user}, {<span class="hljs-string">'access.ban'</span> : <span class="hljs-literal">false</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, rows</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-built_in">console</span>.log(err);
      res.sendStatus(<span class="hljs-number">500</span>);
    } <span class="hljs-keyword">else</span> {
      res.sendStatus(<span class="hljs-number">200</span>);
    }
  });
});

<span class="hljs-comment">/**
 * Validation d'un compte utilisateur
 */</span>
router.post(<span class="hljs-string">'/validate'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Validation d'un user..."</span>);
  userSchema.findOneAndUpdate({<span class="hljs-string">'access.validationKey'</span>: req.body.hash}, {<span class="hljs-string">'access.validationKey'</span>: <span class="hljs-string">''</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, rowUpdated</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Validate first error : "</span> + err);
      res.sendStatus(<span class="hljs-number">500</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (rowUpdated !== <span class="hljs-literal">null</span>) {
        req.body = {
          <span class="hljs-string">"email"</span>: rowUpdated.email,
          <span class="hljs-string">"password"</span>: rowUpdated.password
        };
        res.sendStatus(<span class="hljs-number">200</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>TODO quand le bypass de connexion sera implémenté</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-comment">/*login(req, res, function(err) {
          console.log("Validate second error : " + err);
          res.sendStatus(500);
        }, true);*/</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Validation not complete"</span>);
        res.sendStatus(<span class="hljs-number">500</span>);
      }
    }
  });
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params">req, res, next</span>) </span>{<span class="hljs-comment">// Ajouter une option de bypass pour si le mot de passe est déjà crypté (validation de compte)</span>
  passport.authenticate(<span class="hljs-string">"local"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user, info</span>) </span>{
    <span class="hljs-built_in">console</span>.log(info);
    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-keyword">return</span> res.sendStatus(<span class="hljs-number">401</span>);
    }
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> next(err);
    }
    req.logIn(user, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> next(err);
      }
      <span class="hljs-keyword">return</span> res.end(<span class="hljs-built_in">JSON</span>.stringify(user));</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>return res.sendStatus(200);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    });
  })(req, res, next);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>—————————— Events ——————————</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> userEvent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ServerEvent</span>) </span>{
  ServerEvent.on(<span class="hljs-string">'isMailExist'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">email, socket</span>) </span>{
    email = email.toLowerCase();
    userSchema.findOne({<span class="hljs-attr">email</span>: email}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, doc</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.log(err);
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (doc != <span class="hljs-literal">null</span> &amp;&amp; doc.email === email) {
        ServerEvent.emit(<span class="hljs-string">'isMailExistResult'</span>, <span class="hljs-literal">true</span>, socket);
      }
      <span class="hljs-keyword">else</span> {
        ServerEvent.emit(<span class="hljs-string">'isMailExistResult'</span>, <span class="hljs-literal">false</span>, socket);
      }
    });
  });
  
  ServerEvent.on(<span class="hljs-string">'isPseudoExist'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pseudo, socket</span>) </span>{
    userSchema.findOne({<span class="hljs-attr">pseudo</span>: pseudo}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, doc</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.log(err);
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (doc != <span class="hljs-literal">null</span> &amp;&amp; doc.pseudo === pseudo) {
        ServerEvent.emit(<span class="hljs-string">'isPseudoExistResult'</span>, <span class="hljs-literal">true</span>, socket);
      }
      <span class="hljs-keyword">else</span> {
        ServerEvent.emit(<span class="hljs-string">'isPseudoExistResult'</span>, <span class="hljs-literal">false</span>, socket);
      }
    });
  });
};


exports.userEvent = userEvent;
exports.router = router;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

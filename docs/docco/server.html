<!DOCTYPE html>

<html>
<head>
  <title>server.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>server.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre> <span class="hljs-comment">/**
 * @file server.js
 * @desc Point d'entrée de l'application 'Gaming-Gen'. &lt;br /&gt;
 * L'application Gaming-Gen permet de gérer entièrement notre évènement. &lt;br /&gt;
 * blablabla &lt;br /&gt;
 * &lt;br /&gt;
 * &lt;b&gt;~5 306 442&lt;/b&gt; de lignes de code &lt;br /&gt;
 * &lt;br /&gt;
 * Date de Création 30/04/2016 &lt;br /&gt;
 * Date de modification 02/09/2017 &lt;br /&gt;
 * 
 * @version Alpha 1.4.0
 * 
 * @author Jérémy Young            &lt;darkterra01@gmail.com&gt;
 * @author Loïc Tardivel-Lacombe   &lt;loic.tardivel@gmail.com&gt;
 * @author Laura Auboin Maurizio   &lt;lala@gaming-gen.fr&gt;
 * @author Frédéric Guazzini       &lt;dolz@gaming-gen.fr&gt;
 * 
 */</span>
<span class="hljs-meta">
'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Requires</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> express       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app           = express();
<span class="hljs-keyword">const</span> compression   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'compression'</span>);
<span class="hljs-keyword">const</span> http          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>).Server(app);
<span class="hljs-keyword">const</span> path          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> cookieParser  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-parser'</span>);
<span class="hljs-keyword">const</span> bodyParser    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>);
<span class="hljs-keyword">const</span> colors        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'colors'</span>);
<span class="hljs-keyword">const</span> fs            = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> session       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);
<span class="hljs-keyword">const</span> mongoose      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">const</span> passport      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);
<span class="hljs-keyword">const</span> LocalStrategy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-local'</span>).Strategy;
<span class="hljs-keyword">const</span> MongoStore    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-mongo'</span>)(session);
<span class="hljs-keyword">const</span> os            = <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>);
<span class="hljs-keyword">const</span> moment        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'moment'</span>);
<span class="hljs-keyword">const</span> nodemailer    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nodemailer'</span>);
<span class="hljs-keyword">const</span> sticky        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sticky-session'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>let resumable    = require(‘./resumable-node.js’)(‘tmp/‘);
let shelljs      = require(‘shelljs’);</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>PMX For PM2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> pmx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pmx'</span>).init({
  <span class="hljs-attr">http</span>          : <span class="hljs-literal">true</span>, <span class="hljs-comment">// HTTP routes logging (default: true)</span>
  ignore_routes : [<span class="hljs-regexp">/socket\.io/</span>, /notFound/], <span class="hljs-comment">// Ignore http routes with this pattern (Default: [])</span>
  errors        : <span class="hljs-literal">true</span>, <span class="hljs-comment">// Exceptions loggin (default: true)</span>
  custom_probes : <span class="hljs-literal">true</span>, <span class="hljs-comment">// Auto expose JS Loop Latency and HTTP req/s as custom metrics</span>
  network       : <span class="hljs-literal">true</span>, <span class="hljs-comment">// Network monitoring at the application level</span>
  ports         : <span class="hljs-literal">true</span>  <span class="hljs-comment">// Shows which ports your app is listening on (default: false)</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>mongoose</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>mongoose.connect(<span class="hljs-string">'mongodb://localhost/gaminggen'</span>, (err) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.error(err);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>TODO à changer (gestion tentatire reconnexions)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        process.exit(<span class="hljs-number">1</span>);
    }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Server Events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> ServerEvent  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/ServerEvent'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Require Controllers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> logger      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/logger'</span>);
<span class="hljs-keyword">const</span> User        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/users'</span>);
<span class="hljs-keyword">const</span> Conf        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/confs'</span>);
<span class="hljs-keyword">const</span> Article     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/articles'</span>);
<span class="hljs-keyword">const</span> Comment     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/comments'</span>);
<span class="hljs-keyword">const</span> Partenaire  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/partenaires'</span>);
<span class="hljs-keyword">const</span> WatchList   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/watchLists'</span>);
<span class="hljs-keyword">const</span> Team        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/teams'</span>);
<span class="hljs-keyword">const</span> Snack       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/snacks'</span>);
<span class="hljs-keyword">const</span> MenuSnack   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/menuSnacks'</span>);
<span class="hljs-keyword">const</span> Shop        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/shop'</span>);
<span class="hljs-keyword">const</span> Order       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/order'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Conf color</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>colors.setTheme({
  <span class="hljs-attr">silly</span>   : <span class="hljs-string">'rainbow'</span>,
  <span class="hljs-attr">input</span>   : <span class="hljs-string">'grey'</span>,
  <span class="hljs-attr">verbose</span> : <span class="hljs-string">'cyan'</span>,
  <span class="hljs-attr">prompt</span>  : <span class="hljs-string">'grey'</span>,
  <span class="hljs-attr">info</span>    : <span class="hljs-string">'green'</span>,
  <span class="hljs-attr">data</span>    : <span class="hljs-string">'grey'</span>,
  <span class="hljs-attr">help</span>    : <span class="hljs-string">'cyan'</span>,
  <span class="hljs-attr">warn</span>    : <span class="hljs-string">'yellow'</span>,
  <span class="hljs-attr">debug</span>   : <span class="hljs-string">'blue'</span>,
  <span class="hljs-attr">error</span>   : <span class="hljs-string">'red'</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Conf port</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> port = process.env.PORT || <span class="hljs-number">3000</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Conf session</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> EXPRESS_SID_VALUE = <span class="hljs-string">'Secret Keyboard DarkTerra Cat'</span>;
<span class="hljs-keyword">const</span> sessionMiddleware = session({
  <span class="hljs-attr">secret</span>              : EXPRESS_SID_VALUE,
  <span class="hljs-attr">resave</span>              : <span class="hljs-literal">true</span>,
  <span class="hljs-attr">saveUninitialized</span>   : <span class="hljs-literal">true</span>,
  <span class="hljs-attr">store</span>               : <span class="hljs-keyword">new</span> MongoStore({ <span class="hljs-attr">mongooseConnection</span>: mongoose.connection })
});</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Conf app</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.use(compression({<span class="hljs-attr">filter</span>: shouldCompress}));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));
app.use(cookieParser());
app.use(sessionMiddleware);
app.use(passport.initialize());
app.use(passport.session());
app.use(pmx.expressErrorHandler());
app.use(<span class="hljs-built_in">require</span>(<span class="hljs-string">'morgan'</span>)(<span class="hljs-string">"combined"</span>, { <span class="hljs-string">"stream"</span>: logger.stream }));</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Conf passport</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> authStrategy = <span class="hljs-keyword">new</span> LocalStrategy({
	<span class="hljs-attr">usernameField</span>: <span class="hljs-string">'email'</span>,
	<span class="hljs-attr">passwordField</span>: <span class="hljs-string">'password'</span>
}, (email, password, done) =&gt; {
	User.userSchema.authenticate(email, password, (error, user) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>You can write any kind of message you’d like.
The message will be displayed on the next page the user visits.
We’re currently not displaying any success message for logging in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'server.js - error: '</span>, error);
		done(error, user, error ? { <span class="hljs-attr">message</span>: error.message } : <span class="hljs-literal">null</span>);
	});
});

<span class="hljs-keyword">let</span> authSerializer = <span class="hljs-function">(<span class="hljs-params">user, done</span>) =&gt;</span> {
	done(<span class="hljs-literal">null</span>, {<span class="hljs-attr">_id</span>: user._id, <span class="hljs-attr">permissions</span>: user.access.permissions});
};

<span class="hljs-keyword">let</span> authDeserializer = <span class="hljs-function">(<span class="hljs-params">user, done</span>) =&gt;</span> {
	User.userSchema.findById(user._id, (error, user) =&gt; {
		done(error, user);
	});
};

passport.use(authStrategy);
passport.serializeUser(authSerializer);
passport.deserializeUser(authDeserializer);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Socket io</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">require</span>(<span class="hljs-string">'./Controller/sockets'</span>).listen(http, sessionMiddleware, ServerEvent, colors);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Call Events Management</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Snack.snackEvent(ServerEvent);
Conf.confEvent(ServerEvent);
MenuSnack.menuSnackEvent(ServerEvent);
Article.articleEvent(ServerEvent);
Comment.commentEvent(ServerEvent);
User.userEvent(ServerEvent);
Shop.shopEvent(ServerEvent);
Order.orderEvent(ServerEvent);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Log Error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>ServerEvent.on(<span class="hljs-string">'error'</span>, (err) =&gt; {
  <span class="hljs-built_in">console</span>.log(err);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Routing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>app.use(express.static(path.join(__dirname, <span class="hljs-string">'View'</span>)));
app.use(<span class="hljs-string">'/users'</span>, User.router);
app.use(<span class="hljs-string">'/confs'</span>, Conf.router);
app.use(<span class="hljs-string">'/articles'</span>, Article.router);
app.use(<span class="hljs-string">'/comments'</span>, Comment.router);
app.use(<span class="hljs-string">'/teams'</span>, Team.router);
app.use(<span class="hljs-string">'/snacks'</span>, Snack.router);
app.use(<span class="hljs-string">'/menusnacks'</span>, MenuSnack.router);
app.use(<span class="hljs-string">'/shop'</span>, Shop.router);
app.use(<span class="hljs-string">'/order'</span>, Order.router);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>ServerEvent.on(<span class="hljs-string">'sendMailContact'</span>, (data, socket) =&gt; {
  SendMail(data.email, data.subject, <span class="hljs-string">'contact@gaming-gen.fr'</span>, data.text, socket);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shouldCompress</span>(<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-keyword">if</span> (req.headers[<span class="hljs-string">'x-no-compression'</span>]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>don’t compress responses with this request header </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>fallback to standard filter function </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> compression.filter(req, res);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ensureAuthenticated</span>(<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">if</span> (req.isAuthenticated()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>req.user is available for use here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Im Auth Muahahahahahahahahhahahahahahhahah !!!'</span>);
    <span class="hljs-keyword">return</span> next();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>denied</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  res.status(<span class="hljs-number">401</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Gestion message de démarrage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startMessage</span> (<span class="hljs-params">err, nodeVersion, refVersion</span>) </span>{
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`La version du serveur Node.JS doit être plus récente : `</span>.warn);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Version demandé : <span class="hljs-subst">${refVersion}</span>, votre version : <span class="hljs-subst">${nodeVersion}</span>`</span>.data);
  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`\nVersion du server OK...`</span>.verbose);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`La version du serveur Node.JS : `</span>.data + process.version.warn);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Le serveur Node.JS fonctionne sur la plateforme : `</span>.data + process.platform.warn);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Mail…
create reusable transporter object using SMTP transport </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> transporter = nodemailer.createTransport({
    <span class="hljs-attr">service</span>: <span class="hljs-string">'Gmail'</span>,
    <span class="hljs-attr">auth</span>: {
        <span class="hljs-attr">user</span>: process.env.NODEMAILER_MAIL,
        <span class="hljs-attr">pass</span>: process.env.NODEMAILER_PASS
    }
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SendMail</span>(<span class="hljs-params">from, subject, to, text, socket</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Gestion mail Contact</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Sending Mail...'</span>.info);
  text = <span class="hljs-string">`Vous avez reçu un mail de : <span class="hljs-subst">${<span class="hljs-keyword">from</span>}</span> : \n\n<span class="hljs-subst">${text}</span>`</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>setup e-mail data with unicode symbols </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> mailOptions = {
      <span class="hljs-attr">from</span>: <span class="hljs-keyword">from</span>, <span class="hljs-comment">// sender address </span>
      to: to, <span class="hljs-comment">// list of receivers </span>
      subject: subject, <span class="hljs-comment">// Subject line </span>
      text: text, <span class="hljs-comment">// plaintext body </span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>html: html, // html body</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      attachments: []
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Pour attacher des pièces
for(let IMG of tabIMG) {
  attach = {};
  attach.filename = IMG;
  attach.path = IMG;
  mailOptions.attachments.push(attach);
}</p>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>send mail with defined transport object </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  transporter.sendMail(mailOptions, (error, info) =&gt; {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'info: '</span>, info);
      <span class="hljs-keyword">if</span>(error) {
        <span class="hljs-built_in">console</span>.error(error);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>res.status(500).json({message : <code>Problème lors de l&#39;envoie du mail</code>});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ServerEvent.emit(<span class="hljs-string">'ErrorOnMailContactSent'</span>, error, socket);
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Message sent: <span class="hljs-subst">${info}</span>`</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>res.status(200).json({message : ‘Mail envoyé !’});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ServerEvent.emit(<span class="hljs-string">'mailContactSent'</span>, info, socket);
      }
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Check Version of Node before Launch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>fs.readFile(__dirname + <span class="hljs-string">'/package.json'</span>, <span class="hljs-string">'utf8'</span>, (err, data) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    
    <span class="hljs-keyword">const</span> operator          = <span class="hljs-built_in">JSON</span>.parse(data).engines.node.replace(<span class="hljs-regexp">/[0-9.]/g</span>, <span class="hljs-string">''</span>);
    <span class="hljs-keyword">const</span> refVersion        = <span class="hljs-built_in">JSON</span>.parse(data).engines.node.replace(<span class="hljs-regexp">/[^0-9.]/g</span>, <span class="hljs-string">''</span>).split(<span class="hljs-string">'.'</span>);
    <span class="hljs-keyword">const</span> nodeVersion       = process.version.replace(<span class="hljs-regexp">/[^0-9.]/g</span>, <span class="hljs-string">''</span>).split(<span class="hljs-string">'.'</span>);
    <span class="hljs-keyword">const</span> refVersionMajeur  = <span class="hljs-built_in">parseInt</span>(refVersion[<span class="hljs-number">0</span>], <span class="hljs-number">10</span>);
    <span class="hljs-keyword">const</span> refVersionMineur  = <span class="hljs-built_in">parseInt</span>(refVersion[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>);
    <span class="hljs-keyword">const</span> refVersionFix     = <span class="hljs-built_in">parseInt</span>(refVersion[<span class="hljs-number">2</span>], <span class="hljs-number">10</span>);
    <span class="hljs-keyword">const</span> nodeVersionMajeur = <span class="hljs-built_in">parseInt</span>(nodeVersion[<span class="hljs-number">0</span>], <span class="hljs-number">10</span>);
    <span class="hljs-keyword">const</span> nodeVersionMineur = <span class="hljs-built_in">parseInt</span>(nodeVersion[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>);
    <span class="hljs-keyword">const</span> nodeVersionFix    = <span class="hljs-built_in">parseInt</span>(nodeVersion[<span class="hljs-number">2</span>], <span class="hljs-number">10</span>);
    
    <span class="hljs-keyword">if</span> (operator === <span class="hljs-string">'&gt;='</span>) {
      <span class="hljs-keyword">if</span> (nodeVersionMajeur &gt; refVersionMajeur) {
        startMessage(<span class="hljs-literal">undefined</span>, nodeVersion, refVersion);
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nodeVersionMajeur == refVersionMajeur &amp;&amp; nodeVersionMineur &gt; refVersionMineur) {
        startMessage(<span class="hljs-literal">undefined</span>, nodeVersion, refVersion);
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nodeVersionMajeur == refVersionMajeur &amp;&amp; nodeVersionMineur == refVersionMineur &amp;&amp; nodeVersionFix &gt;= refVersionFix) {
        startMessage(<span class="hljs-literal">undefined</span>, nodeVersion, refVersion);
      }
      <span class="hljs-keyword">else</span> {
        startMessage(<span class="hljs-string">'not OK'</span>, nodeVersion, refVersion);
        process.exit(<span class="hljs-number">1</span>);
      }
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`L'operateur (package.json =&gt; engine) doit être égal à : '&gt;='`</span>.warn);
      process.exit(<span class="hljs-number">1</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Création du serveur</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    http.listen(port, () =&gt; {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`\n\nSI-GamingGen listening at 127.0.0.1:<span class="hljs-subst">${port}</span>`</span>.verbose);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'La plateforme fonctionne depuis : '</span>.data + colors.warn(moment.duration((os.uptime().toFixed(<span class="hljs-number">0</span>))*<span class="hljs-number">1000</span>).humanize()));
      <span class="hljs-built_in">console</span>.log();
    });
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>pmx.emit(‘user:register’, {
  user : ‘Alex registered’,
  email : ‘thorustor@gmail.com’
});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>


<span class="hljs-comment">/*------------------------------------------------------------------------------------------------------------------------------*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Handle uploads through Resumable.js
app.post(‘/upload’, function(req, res){
  //console.log(req);</p>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>  resumable.post(req, function(status, filename, original_filename, identifier, nomFinal){
    //console.log(‘POST’, status, original_filename, identifier);</p>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <pre><code><span class="hljs-keyword">if</span> (status == <span class="hljs-string">'done'</span>) {
  <span class="hljs-keyword">var</span> racine            = <span class="hljs-string">"/home/pi/www/"</span>;
  <span class="hljs-keyword">var</span> path              = racine + <span class="hljs-string">"finish/"</span>;
  <span class="hljs-keyword">var</span> nomFinal          = req.param(<span class="hljs-string">'nom_Final'</span>);
  <span class="hljs-keyword">var</span> directoryName     = path + <span class="hljs-string">''</span> + req.param(<span class="hljs-string">'film_Or_Serie'</span>) + <span class="hljs-string">'/'</span> + nomFinal + <span class="hljs-string">'('</span> +  req.param(<span class="hljs-string">'anne_Film'</span>) + <span class="hljs-string">')'</span>;
  <span class="hljs-keyword">var</span> destFileFinal     = directoryName + <span class="hljs-string">'/'</span>;
  <span class="hljs-keyword">var</span> resumableFilename = req.param(<span class="hljs-string">'resumableFilename'</span>);
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <pre><code>  <span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <pre><code>  nomFinal = nomFinal + <span class="hljs-string">'.'</span> + resumableFilename.substr((resumableFilename.lastIndexOf(<span class="hljs-string">'.'</span>) +<span class="hljs-number">1</span>));
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <pre><code>  fs.exists(destFileFinal, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">exists</span>) </span>{
    <span class="hljs-keyword">if</span> (! exists) {
      shelljs.mkdir(<span class="hljs-string">'-p'</span>, destFileFinal);
    }
    destFileFinal = destFileFinal + <span class="hljs-string">''</span> + nomFinal;
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <pre><code>    <span class="hljs-keyword">var</span> ws = fs.createWriteStream(destFileFinal);
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <pre><code>    resumable.write(identifier, ws);
    ws.on(<span class="hljs-string">'finish'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Fichier : '</span> + nomFinal + <span class="hljs-string">' Enregistré...'</span>);
      shelljs.rm(<span class="hljs-string">'-rf'</span>, <span class="hljs-string">'temp/*'</span> + identifier + <span class="hljs-string">'*'</span>);
    });
  });
}
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <pre><code>res.send(status, {
  <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> Uncomment this funciton to enable cross-domain request.</span>
  <span class="hljs-comment">//'Access-Control-Allow-Origin': '*'</span>
});
</code></pre><p>  });
});</p>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>// Handle status checks on chunks through Resumable.js
app.get(‘/upload’, function(req, res){
  resumable.get(req, function(status, filename, original_filename, identifier){
    //console.log(‘GET’, status);
    res.send((status == ‘found’ ? 200 : 404), status);
  });
});</p>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>app.get(‘/download/:identifier’, function(req, res){
  resumable.write(req.params.identifier, res);
});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/*------------------------------------------------------------------------------------------------------------------------------*/</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
